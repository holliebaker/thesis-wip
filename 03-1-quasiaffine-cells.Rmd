# Quasi-affine cells { #sec:quasi-affine }

Let $$
V := V_1 \cup \ldots \cup V_k
$$
be a family of semialgebraic sets such that $\dim(V_i) \le 2$ for $1\le i \le k$.
According to [@bgv15 Theorem 3.20], there is an algorithm for computing a cylindrical decomposition compatible with $V$, monotone with respect to sets $V_1,\ldots,V_k$ and satisfying the frontier condition. 
The first step is to construct a CAD $\cal D$ compatible with $V$, such that each cell of $\cal D$ is the graph of a quasi-affine map. 
[@bgv15, Lemma 3.19] provides a constructive proof of this result. In this section, we will derive an algorithm for constructing $\cal D$ based on this proof. 

## Computing the smooth two-dimensional locus of $V$

We begin by considering $W$, the smooth $2$-dimensional locus of $V = V_1 \cup \ldots \cup V_k$.
Since $V$ is a semialgebraic set, it can be represented by a quantifier-free Boolean formula $F$. 
$W$ can be computed using the smooth stratification algorithm described in @\ref(sec:smooth-strat).
In order to apply the algorithm, consider the consistent sign assignmunts of polynomials $f_1,\ldots,f_s$ appearing in the formula $F$. As described in Section @\ref(sec:strat-semialgebraic), we obtain a collection of sign-sets $S_{(\ast_1,\ldots,\ast_s)} \subset \R^n$. Observe that a finite number of these sign-sets $S_1,\ldots,S_m$ form a partition of $V$. 
For each of these sign-sets $S_i \subset V$, apply the smooth stratification algorithm to obtain a family $(X_{i,1}, \ldots X_{i,n})$ of strata, where each $X_{i,j}$ is a smooth subset of $S_i$ of codimension $j$. 
We have $\dim(S_i) \le 2$, since each of the sets in the union $V$ has dimension at most 2. Hence, every stratum $X_{i,j}$ of codimension $j < n-2$ will be empty. 
We obtain the smooth two-dimensional locus of $V$ by taking the union of strata of codimension $n-2$. For each of these strata, it is important to keep the set of $n-2$ polynomials defining it, as these will be needed in the next step. We will need the strata of codimension $n-1$, as each one-dimensional cell must also be the graph of a quasi-affine map. 

### An alternative method for computing the smooth two-dimensional locus

Recall from Section \@ref(sec:cad-construction)) that smooth cells can be guaranteed by choosing a certain projection operator.
More precisely, according to @mccallum1988, Theorems 2.2.3 and 2.2.4, if there is a finite number of blow-up points, then the McCallum projection operator will result in a CAD where all cells are analytic submanifolds. 
Since $\dim(V_i) \le 2$ for all $1 \le i \le k$, we may assume that blow-up points will have dimension at most $0$. Hence, the McCallum projection operator will result in smooth cells being produced. 

Let $F \subset \R^n$ be the set of polynomials appearing in the quantifier-free Boolean formulas defining $V$ and use the McCallum projection operator to construct an $F$-invariant CAD, $\cal E$, of $\R^n$. Since cells of a CAD are disjoint by construction and smooth by the use of the McCallum projection operator, $\cal E$ forms a smooth stratification of $V$.
Thus, we can take as $W$ the (separate) sets of $2$- and $1$-dimensional cells of $\cal E$ which are contained in $V$. 
Let $C$ be one of these cells, and suppose it has index $(i_1,\ldots,i_n) \in \{0,1\}^n$. Since $\dim(C) = 2$, $\sum_{1\le i \le n} = 2$. Let $i_{j_1}, = i_{j_2} = 1$ for $j_1 \ne j_2$ and all other elements of the index be equal to zero. Then $\projop{k}(C)$, for $k\ne j_1,k\ne j_2$, is the root of a projection polynomial $f_k \in \Z[x_1,\ldots,x_k]$. Hence, we have, $n-2$ projection polynomials at which every $\mathbf{x} \in C$ is equal to zero. 
The polynomials can be determined by using the set of signs of projection factors and used to define an algebraic variety $V \supset C$. Note that we need some additional inequalities to define $C$ properly, but these are not needed to compute the critical points of projections in the next section. 
Similarly for $1$-dimensional cells, only one element of the index will be equal to $1$, while all other elemens are equal to $0$. It follows that we can find $n-1$ polynomials, in a similar way, which are equal to zero on each one-dimensional cell. 

It is possible to compute $W$ using either technique. Theoretically speaking, using the smooth stratification algorithm seems cleaner, as it is the correct tool for decomposing a set into smooth manifolds.
However, things are often more nuanced in practice. We are required to compute the smooth stratification of each non-empty sign subset of $V$. Thus, we may be required to repeat a doubly exponential operation up to $3^s$ times, where $s$ is the number of different polynomials appearing in the formula for $V$. In addition, the subroutine for eliminating redundant defining polynomials requires repeated emptiness checking. Although, theoretically speaking this can be done in singly exponential time, in practice we it is implemented using CAD. 

Bearing this in mind, one more call to the CAD algorithm, required for the second option, seems a lot more appealing. 
In addition, @kremer2020 propose an algorithm, along with its implementation, for refining a CAD to be compatible with new polynomials. This gives us hope that we may be able to avoid a full recomputation. In conclusion, the second option, where we compute an initial CAD consisting of smooth cells, is more tractable in practice. 

## Ensuring that every cell is the graph of a quasi-affine map

In order to obtain quasi-affine cells, @bgv15, Lemma 3.19 states that the CAD $\cal D$ also needs to be compatible with the critical points, $W_{i}$ and $W_{i,j}$, of projections of $W$ onto one and two-dimensional coordinate subspaces $\opspan{x_i,x_j}$ and $\opspan{x_i}$.

Let $W'_k$ be one of the strata computed in the previous section, with $k\in \{1,2\}$. Since $W'_k$ has codimension $n-k$ and is a basic semialgebraic set, its formula contains $n-k$ polynomial equations and, possibly, some inequalities. 
Consider the Jacobi matrix
$$
J_{i_1,\ldots,i_\ell}:=\begin{pmatrix}\partial f_{1}/\partial x_{i_{1}} & \ldots & \partial f_{1}/\partial x_{i_{\ell}}\\
\vdots &  & \vdots\\
\partial f_{k}/\partial x_{i_{1}} & \ldots & \partial f_{n-k}/\partial x_{i_{\ell}}
\end{pmatrix},
$$
where $\{i_1,\ldots,i_\ell\} \subset \{ 1, \ldots, n \}$. Let $\{j_1,\ldots,j_{n-\ell}\} = \{ 1 , \ldots, n \} \setminus \{ i_1,\ldots,i_\ell \}$. 
Critical points of the projection of $W'$ onto $\opspan\{j_1,\ldots,j_{n - \ell}\}$ are those at which the matrix $J_{i_1,\ldots,i_\ell}$ does not have full rank. 
Thus, we can compute the critical points $W'_{i,j}$ of $\projops{x_i,x_j}$ by finding the points at which the Jacobi matrix $J_{\{1,\ldots,n\} \setminus \{i,j\}}$ does not have full rank. 

Note that, for $W'_{i,j}$, the corresponding $J_{\{1,\ldots,n\} \setminus \{i,j\}}$ will be a $((n-2) \times (n-2))$-matrix, so we simply need to find the points at which $\det(J_{\{1\ldots,n\} \setminus \{i,j\}}) = 0$. 
On the other hand, $J_{\{1,\ldots,n\} \setminus \{i\}}$ will be an $((n-2) \times (n-1))$-matrix. It will fail to have full rank if the determinants of all of the $((n-2) \times (n-2))$ minors is zero. Observe that are $J_{\{1,\ldots,n\} \setminus \{i,j\}}, j \in \{1,\ldots,n\} \setminus \{i\}$. I.e., they will coincide with the square matrices associated with $W'_{i,j}$. Thus, we need to make the CAD have constant sign on
$$
J_{\{1,\ldots,n\} \setminus \{i,j\}} \text{ for all } i \ne j,
$$
for all two-dimensional smooth strata (or cells) of $V$, whose definition includes $n-2$ polynomial equations. 

Consider the critical points $Z$ of $\projops{x_i,x_j}(W'_1)$, where $W'_1$ is a smooth one-dimensional stratum. If $\dim(Z) = 1$, then every point of $\projops{x_i,x_j}(W'_1)$ is critical as $W'_1$ is smooth. Note that thre may be zero-dimensional critical points of $\projops{x_i}$ and $\projops{x_j}$. 
Otherwise, $\dim(Z) = 0$, so $Z$ is a collection of isolated points $(c_i,c_j)$. $c_i$ is also a critical point of $\projops{x_i}(W'_1)$ and $c_j$ is also a critical point of $\projops{x_j}(W'_1)$. Therefore, it is sufficient to consider only critical points of projections onto one-dimensional coordinate subspaces. Hence, we only -consider Jacobi matrices
$J_{\{1,\ldots,n\} \setminus \{i\}}$ for all $1\le i \le n$, for the $n-1$ polynomials defining $W'_1$. Critical points exist when their determinants are equal to zero. 

## Computing the quasi-affine CAD { #sec:quasiaffine-algorithm }

We now present psuedo-code for the quasi-affine part of the algorithm. 

---

**Input:**
$$F$$

  - $F$: a quantifier-free Boolean formula defining
  $$
  V = V_1 \cup \ldots \cup V_k
  $$
  where $V \subset \R^n$ and $\dim(V_i) \le 2, 1 \le i \le k$. 
  
**Output:**
$$
{\cal D}
$$
  - $\cal D$: a CAD of $\R^n$ compatible weth $V$ such that each cell $C \subset V$ is the graph of a quasi-affine map. 

---

- Let $$
\mathbf{F} \subset \Z[x_1,\ldots,x_n]
$$
be the set of polynomials appearing in the formula $F$. 

- Compute $\cal E$, a CAD of $\R^n$ compatible with $V$, using the McCallum projection operator. 

  By @mccallum1988, Theorems 2.2.3 and 2.2.4, each cell $C \subset V$ of $\cal E$ will be an analytic submanifold. 

- Let ${\cal A} = ({\cal A}_1,\ldots,{\cal A}_{n})$ be the family of projection polynomials for $\cal E$, where each ${\cal A}_i \subset \Z[x_1,\ldots,x_i]$.

- For each cell $C_k \subset V$ with index $(i_1,\ldots,i_n) \in \{0,1\}^n$, such that $i_{j_1} = \ldots = i_{j_k} = 1$ while all other elements of the index are equal to $0$ (observe $\dim(C_k) = k$):

  - Let $f_1,\ldots,f_{n-k}$ be a set of projection polynomials which are equal to $0$ on the cell $C_k$.
  
  - For each $i \in \{1,\ldots,n\} \setminus \{j_1,\ldots,j_k\}$, find a polynomial in ${\cal A}_i$ which is $0$ at every point $\mathbf{x} \in C_k$. This can be done by checking the set of signs of projection factors. 

- For each $2$-dimensional cell $C_2 \subset V$ and pair $1 \le i_1 < i_2 \le n$:

  - Find the set of polynomials $f_1,\ldots,f_{n-2}$ defining $C_2$.
  
  - Let $\mathbf{m} = \{j_1,\ldots,j_\ell\} = \{1\ldots,n\} \setminus \{i_1,i_2\}$.
    
  - Define
    $$
    J_{C_2,\mathbf{m}} := 
\begin{pmatrix}\partial f_{1}/\partial x_{i_{1}} & \ldots & \partial f_{1}/\partial x_{i_{\ell}}\\
\vdots &  & \vdots\\
\partial f_{n-2}/\partial x_{i_{1}} & \ldots & \partial f_{n-2}/\partial x_{i_{\ell}}
\end{pmatrix}
    $$
    be an $((n-2)\times (n-2))$ Jacobi matrix.
    
    $\det(J_{C_2,\mathbf{m}}) = 0$ at the critical points of $\projops{i_1,i_2}$.
    
- For each $1$-dimensional cell $C_1 \subset V$ pair $1 \le i_1 < i_2 \le n$:

  - Find the set of polynomials $f_1,\ldots,f_{n-1}$ defining $C_1$.
    
  - Let $\mathbf{m} = \{j_1,\ldots,j_\ell\} = \{1\ldots,n\} \setminus \{i_1\}$.
    
  - Define
  $$
  J_{C_1,\mathbf{m}} := 
\begin{pmatrix}\partial f_{1}/\partial x_{i_{1}} & \ldots & \partial f_{1}/\partial x_{i_{\ell}}\\
\vdots &  & \vdots\\
\partial f_{n-2}/\partial x_{i_{1}} & \ldots & \partial f_{n-1}/\partial x_{i_{\ell}}
\end{pmatrix}
  $$
  be an $((n-1)\times (n-1))$ Jacobi matrix.
    
  $\det(J_{C_1,\mathbf{m}}) = 0$ at the critical points of $\projops{i_1}$.

  - Return the CAD $\cal D$, which is sign invariant on
  $$
  \mathbf{F} \cup 
  \bigcup_{C_2 \subset V,\mathbf{m} = \{1,\ldots,n\} \setminus \{i_1,i_2\}} \det\left(J_{C_2,\mathbf{m}}\right),
  \bigcup_{C_1 \subset V,\mathbf{n} = \{1,\ldots,n\} \setminus \{i_1\}} \det\left(J_{C_1,\mathbf{n}}\right)
  $$
  for each two and one-dimensional cell $C_1,C_2 \subset V$ of $\cal E$ and each pair $0\le i_1 < i_2 \le n$. 


